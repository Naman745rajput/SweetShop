<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Sweet Shop</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fce4ec; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }

        /* Sections */
        .section { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }

        /* Login */
        #login-section { max-width: 400px; margin: 50px auto; text-align: center; }

        /* Admin Panel */
        #admin-section { border-left: 5px solid #e91e63; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }

        /* Inputs & Buttons */
        input, textarea { padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #e91e63; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #c2185b; }
        button.secondary { background-color: #555; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card img { max-width: 100%; height: 150px; object-fit: cover; border-radius: 4px; }
        .price { color: #e91e63; font-weight: bold; font-size: 1.2em; margin: 10px 0; }

        /* Messages */
        .message { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">

    <div id="login-section" class="section">
        <h2>üç¨ Sweet Shop Login</h2>
        <div class="form-group">
            <input type="text" id="username" placeholder="Username">
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="Password">
        </div>
        <button onclick="login()">Login</button>

        <p style="margin-top: 15px; font-size: 0.9em;">
            Don't have an account?
            <a href="#" onclick="showRegister()" style="color: #e91e63; font-weight: bold;">Register here</a>
        </p>

        <div id="login-msg" class="message"></div>
    </div>

    <div id="register-section" class="section hidden" style="max-width: 400px; margin: 50px auto; text-align: center;">
        <h2>üìù Create Account</h2>
        <div class="form-group">
            <input type="text" id="reg-username" placeholder="Choose a Username">
        </div>
        <div class="form-group">
            <input type="password" id="reg-password" placeholder="Choose a Password">
        </div>
        <button onclick="register()">Sign Up</button>

        <p style="margin-top: 15px; font-size: 0.9em;">
            Already have an account?
            <a href="#" onclick="showLogin()" style="color: #e91e63; font-weight: bold;">Login here</a>
        </p>

        <div id="reg-msg" class="message"></div>
    </div>

    <div id="admin-section" class="section hidden">
        <h3>‚ö° Admin Dashboard</h3>

        <div style="border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
            <h4>Add New Sweet</h4>
            <div class="form-group">
                <input type="text" id="sweet-name" placeholder="Name">
            </div>
            <div class="form-group">
                <input type="number" step="0.01" id="sweet-price" placeholder="Price ($)">
            </div>
            <div class="form-group">
                <input type="number" id="sweet-quantity" placeholder="Quantity (Stock)" value="50">
            </div>
            <div class="form-group">
                <input type="text" id="sweet-image" placeholder="Image URL">
            </div>

            <button onclick="addSweet()">Add Product</button>
            <div id="admin-msg" class="message"></div>
        </div>

        <div>
            <h4>Store Management</h4>
            <button onclick="loadAllOrders()" style="background-color: #673ab7;">View All Customer Orders</button>
            <div id="admin-orders-list" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div id="shop-section" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Our Sweets</h1>
            <div>
                <button onclick="toggleCart()" style="background-color: #ff9800; margin-right: 10px;">
                    üõí Cart (<span id="cart-count">0</span>)
                </button>
                <button class="secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="cart-panel" style="background: #fff3e0; padding: 15px; border: 1px solid #ffb74d; border-radius: 8px; margin-bottom: 20px; display: none;">
            <h3>üõí Your Shopping Cart</h3>
            <div id="cart-items-list">Your cart is empty.</div>
            <h4 style="text-align: right;">Total: $<span id="cart-total">0.00</span></h4>
            <div style="text-align: right;">
                <button onclick="clearCart()" class="secondary">Clear</button>
                <button onclick="checkout()" style="background-color: #4caf50;">‚úÖ Checkout Now</button>
            </div>
        </div>

        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="search-box" placeholder="Search for cakes, cookies..."
                   style="padding: 10px; width: 100%; max-width: 400px; border: 2px solid #ddd; border-radius: 25px;">
            <button onclick="searchSweets()" style="background-color: #2196F3; border-radius: 25px;">üîç Search</button>
            <button onclick="clearSearch()" class="secondary" style="border-radius: 25px;">Clear</button>
        </div>

        <div id="sweets-grid" class="grid"></div>
        <div id="order-msg" class="message" style="text-align: center;"></div>
    </div>

    <div id="edit-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index: 1000;">
        <div style="background:white; padding:25px; border-radius:10px; width:300px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <h3>‚úèÔ∏è Edit Sweet</h3>
            <input type="hidden" id="edit-id">

            <div class="form-group">
                <input type="text" id="edit-name" placeholder="Name">
            </div>

            <div class="form-group">
                <input type="text" id="edit-category" placeholder="Category (e.g. Cakes)">
            </div>

            <div class="form-group">
                <input type="number" step="0.01" id="edit-price" placeholder="Price">
            </div>
            <div class="form-group">
                <input type="number" id="edit-quantity" placeholder="Stock Quantity">
            </div>

            <button onclick="submitEdit()" style="width: 100%; margin-top: 10px;">üíæ Save Changes</button>
            <button onclick="closeEditModal()" class="secondary" style="width: 100%; margin-top: 10px;">Cancel</button>
        </div>
    </div>

</div>

<script>
    let authToken = '';
    let userRole = '';
    let cart = []; // <-- THE SHOPPING CART

    // --- 1. LOGIN ---
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const msgDiv = document.getElementById('login-msg');

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                authToken = data.token;
                userRole = data.role;

                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('shop-section').classList.remove('hidden');

                if (userRole === 'ROLE_ADMIN') {
                    document.getElementById('admin-section').classList.remove('hidden');
                }

                loadSweets();
            } else {
                showMsg(msgDiv, 'Invalid Credentials', false);
            }
        } catch (error) {
            console.error(error);
            showMsg(msgDiv, 'Login failed', false);
        }
    }

    // --- UI TOGGLES ---
    function showRegister() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('register-section').classList.remove('hidden');
        clearMessages();
    }

    function showLogin() {
        document.getElementById('register-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        clearMessages();
    }

    function clearMessages() {
        document.getElementById('login-msg').style.display = 'none';
        document.getElementById('reg-msg').style.display = 'none';
    }

    // --- REGISTER FUNCTION ---
    async function register() {
        const username = document.getElementById('reg-username').value;
        const password = document.getElementById('reg-password').value;
        const msgDiv = document.getElementById('reg-msg');

        if(!username || !password) {
            showMsg(msgDiv, "Please fill all fields", false);
            return;
        }

        try {
            // We hardcode ROLE_USER so people can't register as Admin from the UI
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    role: "ROLE_USER"
                })
            });

            if (response.ok) {
                // Success!
                alert("Registration Successful! Please Login.");
                showLogin(); // Switch back to login screen
                // Optional: Pre-fill the login username
                document.getElementById('username').value = username;
            } else {
                showMsg(msgDiv, 'Username already exists', false);
            }
        } catch (error) {
            console.error(error);
            showMsg(msgDiv, 'Registration failed', false);
        }
    }

    // --- 2. LOAD SWEETS (Correct Version) ---
    async function loadSweets(query = '') {
        const grid = document.getElementById('sweets-grid');
        grid.innerHTML = '<p>Loading...</p>';

        try {
            // Decide which API endpoint to hit
            let url = '/api/sweets';
            if (query) {
                url = '/api/sweets/search?keyword=' + encodeURIComponent(query);
            }

            const response = await fetch(url);
            const sweets = await response.json();

            grid.innerHTML = '';

            if (sweets.length === 0) {
                grid.innerHTML = '<p>No sweets found.</p>';
                return;
            }

            sweets.forEach(sweet => {
                const card = document.createElement('div');
                card.className = 'card';
                const img = sweet.imageUrl || 'https://via.placeholder.com/150?text=Sweet';
                const qty = sweet.quantity || 0;
                const category = sweet.category || 'General'; // Show Category

                // CARD HTML
                let cardHtml = `
                    <img src="${img}" alt="${sweet.name}">
                    <h3>${sweet.name}</h3>
                    <div style="color: #888; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px;">
                        ${category}
                    </div>
                    <div class="price">$${sweet.price}</div>
                    <div style="font-size: 0.9em; color: #555; margin-bottom: 10px;">
                        <strong>Stock:</strong> ${qty} left
                    </div>
                `;

                // BUTTON LOGIC
                if (userRole === 'ROLE_ADMIN') {
                    cardHtml += `
                        <button onclick="openEditModal(${sweet.id}, '${sweet.name}', '${category}', ${sweet.price}, ${qty})"
                                style="background-color: #2196F3; margin-bottom: 5px; width: 100%;">‚úèÔ∏è Edit</button>
                        <button onclick="deleteSweet(${sweet.id})"
                                style="background-color: #d32f2f; width: 100%;">üóëÔ∏è Delete</button>
                    `;
                } else {
                    if (qty > 0) {
                        cardHtml += `<button onclick="addToCart(${sweet.id}, '${sweet.name}', ${sweet.price})">Add to Cart</button>`;
                    } else {
                        cardHtml += `<button disabled style="background-color: #ccc; cursor: not-allowed;">üö´ Out of Stock</button>`;
                    }
                }

                card.innerHTML = cardHtml;
                grid.appendChild(card);
            });
        } catch (error) {
            console.error("Error:", error);
            grid.innerHTML = '<p style="color:red">Error loading sweets.</p>';
        }
    }

    // --- 2. SEARCH FUNCTIONS ---
    function searchSweets() {
        const query = document.getElementById('search-box').value;
        loadSweets(query); // Re-uses the main loader with a query
    }

    function clearSearch() {
        document.getElementById('search-box').value = '';
        loadSweets(); // Reloads all
    }

    // --- 3. EDIT FUNCTIONS ---
    function openEditModal(id, name, category, price, quantity) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-category').value = category;
        document.getElementById('edit-price').value = price;
        document.getElementById('edit-quantity').value = quantity;

        document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    async function submitEdit() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value;
        const category = document.getElementById('edit-category').value;

        // --- CHECK THESE TWO LINES CAREFULLY ---
        const price = document.getElementById('edit-price').value;      // Should match <input id="edit-price">
        const quantity = document.getElementById('edit-quantity').value; // Should match <input id="edit-quantity">

        // Validation to prevent empty errors
        if (!id || !name || !price || !quantity) {
            alert("Please fill all fields!");
            return;
        }

        try {
            const response = await fetch('/api/sweets/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    price: parseFloat(price),      // Force Price to be a number (Decimal)
                    quantity: parseInt(quantity)   // Force Quantity to be an Integer (Whole number)
                })
            });

            if (response.ok) {
                alert("Sweet Updated!");
                closeEditModal();
                loadSweets();
            } else {
                alert("Failed to update (Check Server Console)");
            }
        } catch (error) {
            console.error(error);
        }
    }

    // --- NEW: DELETE FUNCTION ---
    async function deleteSweet(id) {
        if(!confirm("Are you sure you want to delete this sweet?")) return;

        const response = await fetch('/api/sweets/' + id, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.ok) {
            alert("Sweet deleted!");
            loadSweets(); // Refresh the grid
        } else {
            alert("Failed to delete (Are you Admin?)");
        }
    }

    // --- 3. CART FUNCTIONS ---
    function addToCart(id, name, price) {
        const existingItem = cart.find(item => item.sweetId === id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ sweetId: id, name: name, price: price, quantity: 1 });
        }
        updateCartUI();
    }

    function updateCartUI() {
        const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cart-count').innerText = totalCount;

        const listDiv = document.getElementById('cart-items-list');
        const totalSpan = document.getElementById('cart-total');

        if (cart.length === 0) {
            listDiv.innerHTML = 'Your cart is empty.';
            totalSpan.innerText = '0.00';
            return;
        }

        let html = '<ul style="padding-left: 20px;">';
        let totalPrice = 0;

        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            totalPrice += itemTotal;
            html += `<li>
                <strong>${item.name}</strong> x ${item.quantity}
                - $${itemTotal.toFixed(2)}
                <button onclick="removeFromCart(${index})" style="padding: 2px 5px; font-size: 0.8em; background: #e91e63; margin-left: 10px;">x</button>
            </li>`;
        });
        html += '</ul>';

        listDiv.innerHTML = html;
        totalSpan.innerText = totalPrice.toFixed(2);
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartUI();
    }

    function toggleCart() {
        const panel = document.getElementById('cart-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function clearCart() {
        cart = [];
        updateCartUI();
    }

    // --- 4. CHECKOUT ---
    async function checkout() {
        if (cart.length === 0) {
            alert("Cart is empty!");
            return;
        }
        const msgDiv = document.getElementById('order-msg');
        const payload = cart.map(item => ({ sweetId: item.sweetId, quantity: item.quantity }));

        try {
            const response = await fetch('/api/orders/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showMsg(msgDiv, 'Checkout Successful! üéâ', true);
                clearCart();
                document.getElementById('cart-panel').style.display = 'none';
            } else {
                showMsg(msgDiv, 'Checkout Failed.', false);
            }
        } catch (error) {
            showMsg(msgDiv, 'Server Error', false);
        }
    }

    // --- 5. ADMIN FUNCTIONS ---
    async function addSweet() {
        // Get values using the FIXED IDs
        const name = document.getElementById('sweet-name').value;
        const price = document.getElementById('sweet-price').value;
        const quantity = document.getElementById('sweet-quantity').value;
        const image = document.getElementById('sweet-image').value;
        const msgDiv = document.getElementById('admin-msg');

        if (!name || !price || !quantity) {
            showMsg(msgDiv, "Please fill in Name, Price, and Quantity", false);
            return;
        }

        try {
            const response = await fetch('/api/sweets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    name: name,
                    price: price,
                    quantity: quantity,
                    imageUrl: image
                })
            });

            if (response.ok) {
                showMsg(msgDiv, "Sweet Added Successfully!", true);
                // Clear inputs
                document.getElementById('sweet-name').value = '';
                document.getElementById('sweet-price').value = '';
                document.getElementById('sweet-quantity').value = '50';
                document.getElementById('sweet-image').value = '';
                // Refresh grid to show new item immediately
                loadSweets();
            } else {
                showMsg(msgDiv, "Failed to add sweet", false);
            }
        } catch (error) {
            console.error(error);
            showMsg(msgDiv, "Server Error", false);
        }
    }

    async function loadAllOrders() {
        const listDiv = document.getElementById('admin-orders-list');
        listDiv.innerHTML = 'Loading orders...';

        try {
            const response = await fetch('/api/orders/all', {
                headers: { 'Authorization': 'Bearer ' + authToken }
            });

            if (response.ok) {
                const orders = await response.json();
                if (orders.length === 0) {
                    listDiv.innerHTML = '<p>No orders placed yet.</p>';
                    return;
                }
                let html = '<table border="1" style="width:100%; border-collapse: collapse;">';
                html += '<tr style="background:#eee;"><th>Order ID</th><th>User</th><th>Item</th><th>Qty</th><th>Total</th><th>Date</th></tr>';
                orders.forEach(order => {
                    html += `<tr>
                        <td style="padding:8px;">#${order.id}</td>
                        <td style="padding:8px;"><strong>${order.user.username}</strong></td>
                        <td style="padding:8px;">${order.sweet.name}</td>
                        <td style="padding:8px;">${order.quantity}</td>
                        <td style="padding:8px;">$${order.totalPrice}</td>
                        <td style="padding:8px; font-size:0.8em;">${new Date(order.orderDate).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</table>';
                listDiv.innerHTML = html;
            } else {
                listDiv.innerHTML = '<p style="color:red">Failed to load orders.</p>';
            }
        } catch (error) {
            listDiv.innerHTML = '<p style="color:red">Server Error</p>';
        }
    }

    function logout() { location.reload(); }

    function showMsg(el, text, success) {
        el.textContent = text;
        el.className = 'message ' + (success ? 'success' : 'error');
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }



</script>

</body>
</html>